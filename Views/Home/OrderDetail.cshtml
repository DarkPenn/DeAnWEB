@{
    ViewBag.Title = "Chi Tiết Đơn Hàng";
}
@section styles {
    <link rel="stylesheet" href="~/Content/Css/OrderDetail.css" />
}
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Chi Tiết Hóa Đơn</title>
</head>
<body>
    <div class="container">
        <header>
            <h1>Chi Tiết Đơn Hàng</h1>
            <a href="@Url.Action("OrderHistory","Home")" class="btn-back">← Quay về Lịch Sử Đơn Hàng</a>
        </header>

        <div class="order-info">
            <h2>Thông tin đơn hàng</h2>
            <p><strong>Mã đơn:</strong> <span id="order-id"></span></p>
            <p><strong>Ngày đặt:</strong> <span id="order-date"></span></p>
            <p><strong>Trạng thái:</strong> <span id="order-status"></span></p>
            <p><strong>Phương thức thanh toán:</strong> <span id="order-payment"></span></p>
        </div>

        <div class="customer-info">
            <h2>Người đặt</h2>
            <p><strong>Họ tên:</strong> <span id="customer-name"></span></p>
            <p><strong>Số điện thoại:</strong> <span id="customer-phone"></span></p>
            <p><strong>Địa chỉ giao hàng:</strong> <span id="customer-address"></span></p>
        </div>
        <div class="products-info">
            <h2>Sản phẩm trong đơn hàng</h2>
            <div class="table-wrapper">
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Tên sản phẩm</th>
                            <th>Đơn giá</th>
                            <th>Số lượng</th>
                            <th>Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody id="products-tbody">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="products-summary">
            <p><strong>Tổng cộng:</strong> <span id="products-total">0 ₫</span></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Lấy mã đơn từ query string
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('id');

            if (!orderId) {
                alert("Không tìm thấy mã đơn hàng!");
                window.location.href = '@Url.Action("OderHistory","Home")';
                return;
            }

            // Lấy danh sách đơn hàng từ localStorage
            const ordersHistory = JSON.parse(localStorage.getItem("ordersHistory")) || [];
            const order = ordersHistory.find(o => o.id === orderId);

            if (!order) {
                alert("Không tìm thấy đơn hàng!");
                window.location.href = '@Url.Action("OderHistory","Home")';
                return;
            }

            // Hiển thị thông tin đơn hàng
            document.getElementById("order-id").textContent = order.id;
            document.getElementById("order-date").textContent = order.date;
            document.getElementById("order-status").textContent = order.status || "Đang xử lý";
            document.getElementById("order-payment").textContent = order.paymentMethod;

            const shippingInfo = JSON.parse(localStorage.getItem("shippingInfo")) || {};

            // Hiển thị thông tin người đặt
            document.getElementById("customer-name").textContent = shippingInfo.name || "Chưa cập nhật";
            document.getElementById("customer-phone").textContent = shippingInfo.phone || "Chưa cập nhật";
            document.getElementById("customer-address").textContent = shippingInfo.address || "Chưa cập nhật";

            // Hiển thị danh sách sản phẩm
            const productsTbody = document.getElementById("products-tbody");
            let totalAmount = 0;

            const productsList = order.items || [];

            if (productsList.length > 0) {
                productsList.forEach(product => {
                    const lineTotal = product.price * product.qty;
                    totalAmount += lineTotal;

                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                <td>${product.name}</td>
                <td class="price">${product.price.toLocaleString()} ₫</td>
                <td class="quantity">${product.qty}</td>
                <td class="total">${lineTotal.toLocaleString()} ₫</td>
            `;
                    productsTbody.appendChild(tr);
                });
            } else {
                productsTbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Không có sản phẩm nào</td></tr>`;
            }

            // Hiển thị tổng cộng
            document.getElementById("products-total").textContent = totalAmount.toLocaleString() + " ₫";
        });

    </script>
</body>
</html>
